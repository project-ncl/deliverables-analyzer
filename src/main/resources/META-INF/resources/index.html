<!--

    Copyright (C) 2019 Red Hat, Inc.

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

            http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.

-->
<!DOCTYPE html>
<html lang="en-us">
  <head>
    <title>Deliverables Analyzer</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/css/patternfly.min.css"
      integrity="sha384-nJHx77dqIJ9kzFQqUhPYDKwrwgp5od9/BrMUGQLygWcJu64ODr9qYWLHQ4K/YxpB" crossorigin="anonymous" />
    <link rel="stylesheet" type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/css/patternfly-additions.min.css"
      integrity="sha384-q1wvnTYo0F4qq2mYrUz3DfnaM3gXSkyHfVoGbl4zKuZ9SMlg/JIWBHeU398mRAp4" crossorigin="anonymous" />
    <script src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha384-tsQFqpEReu7ZLhBV2VZlAu7zcOV+rXbYlF2cqB8txI/8aZajjp4Bqd+V6D5IgvKT"
      crossorigin="anonymous"></script>
    <script src="https://cdn.datatables.net/1.10.2/js/jquery.dataTables.min.js"
      integrity="sha384-OusN40V9uheElYuYMeJERIpNypVvwCGSiOprm6DoDmmHahLxtqbzSigc54Y/zCkI"
      crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
      integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
      crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
      integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
      crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/patternfly/3.24.0/js/patternfly.min.js"
      integrity="sha384-4lW8IOzfCHwzlShlG/AP2aYc91C+r+v3lpUEpjBM+FOHy0INgLKgyMBZd7O9ejln"
      crossorigin="anonymous"></script>
    <style type="text/css">
      .c1 {
        padding-left: 3em;
        padding-right: 3em;
      }

    </style>
    <script type="text/javascript">
      $(function() {
        const version = $('#version');

        $.get('/api/version', function(data) {
          version.html(data);
        }).fail(function() {
          version.html('Unknown version');
        });

        // XXX
        let config;
        let table;

        const input = $('#url');
        const submitButton = $('#submitButton');
        const errorAlert = $('#errorAlert');

        $.getJSON('/api/analyze/config', function(data) {
          config = data;
        }).fail(function() {
          errorAlert.html('Fatal error getting configuration').show().alert();
          submitButton.attr('disabled', true);
          input.attr('disabled', true);
        });

        const urlAlert = $('#urlAlert');
        const form = $('#analyzeForm');

        form.submit(function(event) {
          event.preventDefault();

          urlAlert.html('').hide();
          errorAlert.html('').hide();

          if (table != null) {
            table.destroy(true);
          }

          const url = input.val();

          if (url == null || url.trim().length == 0) {
            urlAlert.html('URL cannot be empty').show().alert();

            return;
          }

          let u;

          try {
            u = new URL(url);
          } catch (error) {
            urlAlert.html('Invalid URL: ' + url + ': ' + error).show().alert();

            return;
          }

          const protocol = u.protocol;

          if (protocol != 'http:' && protocol != 'https:') {
            urlAlert.html('Invalid URL protocol: ' + protocol).show().alert();

            return;
          }

          input.attr('disabled', true);
          submitButton.attr('disabled', true);

          $.post('/api/analyze', { url: u.toString() }).done(function(data) {
            handle(config, data);
            input.attr('disabled', false);
            submitButton.attr('disabled', false);
          }).fail(function(jqXHR, textStatus, errorThrown) {
            const responseText = jqXHR.responseText;
            const errorMessage = JSON.parse(responseText);
            let msg = 'Error ' + errorMessage.code + ': ' + errorMessage.reason + '<br \/>' + errorMessage.message +
              '<br \/>';

            if (errorMessage.stack_trace != null) {
              msg += errorMessage.stack_trace.toString().replace(/,/g, '<br \/>');
            }

            if (errorMessage.cause_stack_trace != null) {
              msg += 'Caused by:<br \/>' +
                errorMessage.cause_stack_trace.toString().replace(/,/g, '<br \/>');
            }

            errorAlert.html(msg).show().alert();
            input.attr('disabled', false);
            submitButton.attr('disabled', false);
          });
        });

        function handle(config, data) {
          if (!data.hasOwnProperty('builds')) {
            errorAlert.html('Found zero builds').show().alert();

            return;
          }

          const builds = $('#builds');
          table = builds.DataTable({
            data: data.builds,
            columns: [
              { data: 'identifier' },
              {
                data: 'koji_id', defaultContent: '',
                render: function(data, type) {
                  if (data == null) {
                    return '';
                  }

                  if (type === 'display') {
                    return '<a href="' + config.koji_web_url + '/buildinfo?buildID=' + data + '">' + data + '<\/a>';
                  }

                  return data;
                }
              },
              {
                data: 'pnc_id', defaultContent: '',
                render: function(data, type) {
                  if (data == null) {
                    return '';
                  }

                  if (type === 'display') {
                    return '<a href="' + config.pnc_url + '/pnc-web/#/builds/' + data + '">' + data + '<\/a>';
                  }

                  return data;
                }
              },
              { data: 'built_from_source' },
              { data: 'source', defaultContent: '' },
              { data: 'build_system_type' },
              {
                data: 'artifacts',
                render: function(data, type) {
                  if (type === 'display') {
                    let text = '<ul>';

                    for (i = 0; i < data.length; i++) {
                      a = data[i];
                      text += '<li>';
                      if (a.koji_id != null) {
                        text += '<a href="' + config.koji_web_url + '/archiveinfo?archiveID=' + a.koji_id + '">' + a.identifier + '<\/a>';
                      } else if (a.pnc_id != null) {
                        text += '<a href="' + config.pnc_url + '/pnc-web/#/artifacts/' + a.pnc_id + '">' + a.identifier + '<\/a>';
                      }

                      text += '<\/li>';
                    }

                    text += '<\/ul>';

                    return text;
                  }

                  return data;
                }
              }
            ]
          });

          table.draw();
          builds.show();
        }
      });
    </script>
  </head>
  <body>
    <div class="container-fluid c1">
      <div class="page-header">
        <h1>Deliverables Analyzer ${project.version}</h1>
        <h4 id="version"></h4>
      </div>
      <div class="container-fluid form-container">
        <form id="analyzeForm" class="form-horizontal">
          <div class="form-group">
            <label for="url">URL</label><input id="url" class="form-control input-lg" type="text" />
            <button id="submitButton" type="submit" class="btn btn-primary btn-lg">Analyze</button>
          </div>
          <div id="urlAlert" class="alert alert-danger collapse">
          </div>
        </form>
      </div>
      <div class="table-responsive">
        <table id="builds" class="table table-striped table-bordered table-hover table-condensed collapse">
          <thead>
            <tr>
              <th>Identifier</th>
              <th>Koji ID</th>
              <th>PNC ID</th>
              <th>Built from Source</th>
              <th>Source</th>
              <th>Build System</th>
              <th>Artifacts</th>
            </tr>
          </thead>
        </table>
      </div>
      <div id="errorAlert" class="alert alert-danger collapse">
      </div>
    </div>
  </body>
</html>
